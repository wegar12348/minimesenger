<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: sans-serif; background: #f5f5f5; padding: 20px; }
    .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    h1 { margin-bottom: 20px; color: #333; }
    .auth { margin-bottom: 30px; padding: 20px; background: #f9f9f9; border-radius: 4px; }
    .auth input { padding: 10px; margin-right: 10px; width: 200px; border: 1px solid #ddd; border-radius: 4px; }
    .auth button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .auth button:hover { background: #0056b3; }
    .status { padding: 10px; margin-bottom: 10px; border-radius: 4px; font-weight: bold; }
    .status.ok { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .users-list { margin-top: 30px; }
    .user-item { padding: 15px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .user-info { flex: 1; }
    .user-name { font-weight: bold; font-size: 16px; }
    .user-meta { font-size: 12px; color: #666; margin-top: 5px; }
    .user-actions { display: flex; gap: 10px; }
    .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .btn-reset { background: #ffc107; color: black; }
    .btn-reset:hover { background: #e0a800; }
    .btn-delete { background: #dc3545; color: white; }
    .btn-delete:hover { background: #c82333; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
    .modal.show { display: flex; }
    .modal-content { background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 400px; }
    .modal-content input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; }
    .modal-content button { width: 100%; padding: 10px; margin-top: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .modal-content button:hover { background: #0056b3; }
    .modal-close { background: #6c757d; }
    .modal-close:hover { background: #5a6268; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîê –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
    
    <div class="auth">
      <div id="status"></div>
      <div id="authSection">
        <h3>–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
        <input type="text" id="username" placeholder="–õ–æ–≥–∏–Ω (min)" value="min">
        <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å (1248)" value="1248">
        <button onclick="doLogin()">–í–æ–π—Ç–∏</button>
      </div>
      <div id="loggedIn" style="display: none;">
        <p>‚úì –í—ã –≤–æ—à–ª–∏ –∫–∞–∫: <strong id="currentUser"></strong></p>
        <button onclick="doLogout()" style="background: #6c757d;">–í—ã—Ö–æ–¥</button>
      </div>
    </div>

    <div id="adminPanel" style="display: none;">
      <div class="users-list">
        <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
        <div id="usersList"></div>
      </div>
    </div>
  </div>

  <!-- Modal –¥–ª—è —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è -->
  <div id="resetModal" class="modal">
    <div class="modal-content">
      <h3>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</h3>
      <p id="resetUsername"></p>
      <input type="password" id="newPassword" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
      <button onclick="doResetPassword()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
      <button class="modal-close" onclick="closeResetModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- Modal –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <h3>‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
      <p>–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç <strong id="deleteUsername"></strong>?</p>
      <p style="font-size: 12px; color: #666; margin-top: 10px;">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.</p>
      <button style="background: #dc3545;" onclick="doDelete()">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
      <button class="modal-close" onclick="closeDeleteModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- Modal –¥–ª—è –ø–æ–∫–∞–∑–∞ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è -->
  <div id="passwordModal" class="modal">
    <div class="modal-content">
      <h3>‚úì –ü–∞—Ä–æ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</h3>
      <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong id="passwordUsername"></strong></p>
      <p style="margin-top: 15px; padding: 12px; background: #e7f3ff; border-radius: 4px; font-family: monospace; word-break: break-all;">
        <strong>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</strong><br>
        <span id="newPasswordDisplay" style="font-size: 16px; color: #0056b3;"></span>
      </p>
      <button onclick="copyPassword()" style="background: #28a745;">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      <button class="modal-close" onclick="closePasswordModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <script>
    let currentUser = null;
    let targetUsername = '';

    async function doLogin() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();
      if (data.ok) {
        currentUser = data.user;
        showStatus('‚úì –í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω', 'ok');
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('loggedIn').style.display = 'block';
        document.getElementById('currentUser').textContent = currentUser.username;
        document.getElementById('adminPanel').style.display = 'block';
        loadUsers();
      } else {
        showStatus('‚úó ' + (data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞'), 'error');
      }
    }

    async function doLogout() {
      await fetch('/api/logout', { method: 'POST' });
      currentUser = null;
      document.getElementById('authSection').style.display = 'block';
      document.getElementById('loggedIn').style.display = 'none';
      document.getElementById('adminPanel').style.display = 'none';
      document.getElementById('username').value = 'min';
      document.getElementById('password').value = '1248';
    }

    async function loadUsers() {
      const res = await fetch('/api/admin/users');
      const data = await res.json();
      if (data.users) {
        const html = data.users.map(u => `
          <div class="user-item">
            <div class="user-info">
              <div class="user-name">${u.username} ${u.isAdmin ? 'üëë' : ''}</div>
              <div class="user-meta">ID: ${u.id.substring(0, 8)}...</div>
            </div>
            <div class="user-actions">
              ${u.username !== 'min' ? `
                <button class="btn btn-reset" onclick="openResetModal('${u.username}')">üîë –ü–∞—Ä–æ–ª—å</button>
                <button class="btn btn-delete" onclick="openDeleteModal('${u.username}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
              ` : '<em style="font-size: 12px; color: #666;">–≠—Ç–æ –≤—ã (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)</em>'}
            </div>
          </div>
        `).join('');
        document.getElementById('usersList').innerHTML = html;
      }
    }

    function openResetModal(username) {
      targetUsername = username;
      document.getElementById('resetUsername').textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${username}`;
      document.getElementById('newPassword').value = '';
      document.getElementById('resetModal').classList.add('show');
    }

    function closeResetModal() {
      document.getElementById('resetModal').classList.remove('show');
    }

    async function doResetPassword() {
      const newPassword = document.getElementById('newPassword').value;
      if (!newPassword) {
        showStatus('‚úó –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å', 'error');
        return;
      }
      const res = await fetch(`/api/admin/users/${targetUsername}/reset-password`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: newPassword })
      });
      const data = await res.json();
      if (data.ok) {
        closeResetModal();
        openPasswordModal(targetUsername, newPassword);
      } else {
        showStatus('‚úó ' + (data.error || '–û—à–∏–±–∫–∞'), 'error');
      }
    }

    function openDeleteModal(username) {
      targetUsername = username;
      document.getElementById('deleteUsername').textContent = username;
      document.getElementById('deleteModal').classList.add('show');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('show');
    }

    function openPasswordModal(username, password) {
      document.getElementById('passwordUsername').textContent = username;
      document.getElementById('newPasswordDisplay').textContent = password;
      document.getElementById('passwordModal').classList.add('show');
    }

    function closePasswordModal() {
      document.getElementById('passwordModal').classList.remove('show');
    }

    function copyPassword() {
      const pwd = document.getElementById('newPasswordDisplay').textContent;
      navigator.clipboard.writeText(pwd).then(() => {
        showStatus('‚úì –ü–∞—Ä–æ–ª—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'ok');
      });
    }

    async function doDelete() {
      const res = await fetch(`/api/admin/users/${targetUsername}/delete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await res.json();
      if (data.ok) {
        showStatus(`‚úì –ê–∫–∫–∞—É–Ω—Ç ${targetUsername} —É–¥–∞–ª—ë–Ω`, 'ok');
        closeDeleteModal();
        loadUsers();
      } else {
        showStatus('‚úó ' + (data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'), 'error');
      }
    }

    function showStatus(msg, type) {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = 'status ' + type;
      setTimeout(() => el.textContent = '', 5000);
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É–∂–µ –ª–∏ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω—ã
    fetch('/api/me').then(r => r.json()).then(data => {
      if (data.user) {
        currentUser = data.user;
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('loggedIn').style.display = 'block';
        document.getElementById('currentUser').textContent = currentUser.username;
        document.getElementById('adminPanel').style.display = 'block';
        loadUsers();
      }
    });
  </script>
</body>
</html>
